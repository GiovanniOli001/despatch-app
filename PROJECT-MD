# Dispatch App

**Version:** 1.0.0  
**Last Updated:** January 15, 2025  
**Status:** MVP Development

## Overview

A bus/coach dispatch operations system for managing drivers, vehicles, shifts, rosters, and daily dispatch operations.

Built with:
- **Frontend:** Vanilla JS, deployed on Cloudflare Pages
- **Backend:** Cloudflare Workers (TypeScript)
- **Database:** Cloudflare D1 (SQLite)

## Live URLs

- **Frontend:** https://despatch-app.pages.dev/
- **API:** https://dispatch-api.oliveri-john001.workers.dev

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloudflare    â”‚     â”‚   Cloudflare    â”‚     â”‚   Cloudflare    â”‚
â”‚     Pages       â”‚â”€â”€â”€â”€â–¶â”‚    Workers      â”‚â”€â”€â”€â”€â–¶â”‚       D1        â”‚
â”‚   (Frontend)    â”‚     â”‚   (API)         â”‚     â”‚   (Database)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Core Concepts

### Data Flow
```
Shift Templates    â†’    Roster Entries    â†’    Dispatch View
(What work looks)       (When + Who)           (Daily operations)
```

- **Shift Template:** Reusable definition of a shift (start time, end time, duties)
- **Roster Entry:** A shift scheduled on a specific date, optionally assigned to a driver/vehicle
- **Dispatch:** The daily view showing all roster entries for today

## Database Schema

### Core Tables

| Table | Purpose |
|-------|---------|
| `tenants` | Multi-tenancy support (single tenant for MVP) |
| `depots` | Operating locations/bases |
| `employees` | Drivers and staff |
| `employee_daily_status` | Leave, availability per day |
| `vehicles` | Fleet vehicles |
| `vehicle_daily_status` | Maintenance status per day |
| `customers` | Charter customers |
| `routes` | Regular service routes |
| `duty_types` | Configurable duty types (driving, break, etc.) |
| `pay_types` | Pay categories (standard, overtime, etc.) |
| `shift_templates` | Reusable shift definitions |
| `shift_template_duties` | Duties within a template (offset-based) |
| `roster_entries` | Scheduled shifts on specific dates |
| `roster_duties` | Actual duties for a roster entry |
| `locations` | Pickup/dropoff locations |
| `audit_log` | Change tracking |

### Key Relationships

- Shift templates have many template duties (offset-based times)
- Roster entries instantiate shift templates on specific dates
- Roster entries can have drivers and vehicles assigned
- Roster duties are the actual duties (with real times, not offsets)

## API Endpoints

### Health
- `GET /api/health` - API status check

### Employees
- `GET /api/employees` - List (with search, status, role filters)
- `GET /api/employees/:id` - Get single employee
- `POST /api/employees` - Create employee
- `PUT /api/employees/:id` - Update employee
- `DELETE /api/employees/:id` - Soft delete
- `GET /api/employees/:id/status/:date` - Get daily status
- `PUT /api/employees/:id/status/:date` - Set leave/availability

### Vehicles
- `GET /api/vehicles` - List (with search, capacity filters)
- `GET /api/vehicles/:id` - Get single vehicle
- `POST /api/vehicles` - Create vehicle
- `PUT /api/vehicles/:id` - Update vehicle
- `DELETE /api/vehicles/:id` - Soft delete
- `GET /api/vehicles/:id/status/:date` - Get daily status
- `PUT /api/vehicles/:id/status/:date` - Set maintenance status

### Shift Templates
- `GET /api/shifts` - List templates
- `GET /api/shifts/:id` - Get template with duties
- `POST /api/shifts` - Create template
- `PUT /api/shifts/:id` - Update template
- `DELETE /api/shifts/:id` - Soft delete
- `POST /api/shifts/:id/duties` - Add duty to template
- `PUT /api/shifts/:id/duties/:dutyId` - Update duty
- `DELETE /api/shifts/:id/duties/:dutyId` - Remove duty
- `POST /api/shifts/:id/duplicate` - Copy template

### Roster
- `GET /api/roster` - List entries (with date range, driver, vehicle filters)
- `GET /api/roster/date/:date` - Get single day with all duties
- `GET /api/roster/week/:date` - Get week view
- `GET /api/roster/month/:year/:month` - Get month summary
- `GET /api/roster/:id` - Get single entry with duties
- `POST /api/roster` - Create entry (from template or ad-hoc)
- `PUT /api/roster/:id` - Update entry
- `DELETE /api/roster/:id` - Remove entry
- `PUT /api/roster/:id/assign` - Quick assign driver/vehicle
- `POST /api/roster/copy-day` - Copy a day's roster to another day
- `POST /api/roster/copy-week` - Copy a week's roster to another week
- `POST /api/roster/bulk` - Create multiple entries

### Dispatch
- `GET /api/dispatch/:date` - Full day data for dispatch view
- `POST /api/dispatch/assign` - Assign driver/vehicle
- `POST /api/dispatch/transfer` - Transfer shift
- `POST /api/dispatch/unassign` - Remove assignment
- `PUT /api/dispatch/duty/:id` - Update duty
- `POST /api/dispatch/duty` - Add ad-hoc duty
- `DELETE /api/dispatch/duty/:id` - Delete duty

### Config
- `GET /api/config/duty-types` - List duty types
- `GET /api/config/pay-types` - List pay types
- `GET /api/config/locations` - List locations
- `GET /api/config/routes` - List routes
- `GET /api/config/depots` - List depots

## Frontend Screens

| Screen | Status | Description |
|--------|--------|-------------|
| Dispatch | ğŸ”² Shell only | Daily operations board |
| Operations Calendar | ğŸ”² Placeholder | Week/month view |
| Charters | ğŸ”² Placeholder | Charter bookings |
| Customers | ğŸ”² Placeholder | Customer management |
| HRM | ğŸ”² Shell only | Employee management |
| Vehicles | ğŸ”² Shell only | Fleet management |
| Shift Templates | ğŸ”² Shell only | Template builder |
| Roster | ğŸ”² Shell only | Schedule management |
| Maintenance | ğŸ”² Placeholder | Vehicle maintenance |

## Project Structure

```
dispatch-app/
â”œâ”€â”€ package.json
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html          # App shell
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ main.css        # All styles
â”‚   â””â”€â”€ js/
â”‚       â”œâ”€â”€ api.js          # API client
â”‚       â””â”€â”€ app.js          # Main app logic
â””â”€â”€ workers/
    â”œâ”€â”€ package.json
    â”œâ”€â”€ wrangler.toml       # Cloudflare config
    â”œâ”€â”€ tsconfig.json
    â””â”€â”€ src/
        â”œâ”€â”€ index.ts        # Main router
        â”œâ”€â”€ db/
        â”‚   â””â”€â”€ schema.sql  # Database schema
        â””â”€â”€ routes/
            â”œâ”€â”€ employees.ts
            â”œâ”€â”€ vehicles.ts
            â”œâ”€â”€ shifts.ts
            â”œâ”€â”€ roster.ts
            â”œâ”€â”€ dispatch.ts
            â””â”€â”€ config.ts
```

## Development Workflow

### Making Changes

1. Edit files locally or on GitHub
2. If local, push to GitHub:
   ```
   git add .
   git commit -m "description"
   git push
   ```
3. Cloudflare auto-deploys (~30 seconds)

### Database Changes

For schema changes, use Wrangler CLI:
```bash
cd workers
npx wrangler d1 execute dispatch-db --remote --file=src/db/schema.sql
```

### Local Development

```bash
# Frontend only (uses live API)
npx serve frontend

# Full local stack
npm run dev
```

## Roadmap

### Phase 1: Core CRUD (Current)
- [ ] HRM screen - employee list, create/edit modals
- [ ] Vehicles screen - vehicle list, create/edit modals
- [ ] Shift Templates - template builder with visual timeline
- [ ] Roster - week view, drag-to-roster, copy week

### Phase 2: Dispatch
- [ ] Port full dispatch UI from prototype
- [ ] Connect to live API
- [ ] Real-time updates

### Phase 3: Polish
- [ ] Authentication
- [ ] Mobile responsiveness
- [ ] Toast notifications
- [ ] Error handling

### Phase 4: Advanced
- [ ] Charters module
- [ ] Customer portal
- [ ] Reporting
- [ ] Multi-depot support

## Default Data

The schema seeds these defaults:

**Duty Types:**
- Driving (blue)
- Out of Vehicle (amber)
- Meal Break (green)
- Waiting (gray)
- Charter (purple)
- Dead Running (red)

**Pay Types:**
- Standard (1.0x)
- Overtime (1.5x)
- Double Time (2.0x)
- Penalty Rate (1.25x)
- Allowance (1.0x)
- Unpaid (0x)

**Depot:**
- Main Depot (default)

## Contact

[Add your contact info]
