# Dispatch App - Complete Project Reference

**CRITICAL: Claude must read this entire file before making any changes or suggestions.**

## QUICK FACTS (READ FIRST)

- **User:** John (Windows PC, Brisbane QLD Australia)
- **Local Project Path:** `C:\Users\Giovanni\Downloads\despatch-app`
- **Frontend:** Single HTML file at `frontend/index.html`
- **Backend:** TypeScript files in `workers/src/routes/`
- **Database:** Cloudflare D1 (SQLite)
- **Live App:** https://despatch-app.pages.dev/
- **Live API:** https://dispatch-api.oliveri-john001.workers.dev

## FILE STRUCTURE (EXACT PATHS)

```
C:\Users\Giovanni\Downloads\despatch-app\
├── frontend\
│   └── index.html              ← ALL frontend code (HTML + CSS + JS in one file)
└── workers\
    ├── wrangler.toml           ← Cloudflare Workers config
    └── src\
        ├── index.ts            ← Main router, CORS, helpers
        ├── routes\
        │   ├── employees.ts    ← Employee/HRM API
        │   ├── vehicles.ts     ← Vehicle fleet API
        │   ├── shifts.ts       ← Shift templates API
        │   ├── roster.ts       ← Roster management API
        │   ├── dispatch.ts     ← Daily dispatch API
        │   └── config.ts       ← Config endpoints
        └── db\
            └── schema.sql      ← Database schema
```

## DEPLOYMENT PROCEDURE (WINDOWS - LINE BY LINE)

**CRITICAL: On Windows, NEVER chain commands with && or ;**
**Give each command in a SEPARATE code block.**

### When Claude provides files:

1. User downloads files from Claude to `C:\Users\Giovanni\Downloads\`
2. User copies files to project folders
3. User deploys

### Copy Commands (give these ONE AT A TIME):

For index.html:
```
copy C:\Users\Giovanni\Downloads\index.html C:\Users\Giovanni\Downloads\despatch-app\frontend\index.html
```

For dispatch.ts:
```
copy C:\Users\Giovanni\Downloads\dispatch.ts C:\Users\Giovanni\Downloads\despatch-app\workers\src\routes\dispatch.ts
```

For roster.ts:
```
copy C:\Users\Giovanni\Downloads\roster.ts C:\Users\Giovanni\Downloads\despatch-app\workers\src\routes\roster.ts
```

For shifts.ts:
```
copy C:\Users\Giovanni\Downloads\shifts.ts C:\Users\Giovanni\Downloads\despatch-app\workers\src\routes\shifts.ts
```

For schema.sql or migrations:
```
copy C:\Users\Giovanni\Downloads\migration_xyz.sql C:\Users\Giovanni\Downloads\despatch-app\workers\src\db\migration_xyz.sql
```

### Backend Deploy Commands (ONE AT A TIME):

```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
```

```
npx wrangler deploy
```

### Frontend Deploy Commands (ONE AT A TIME):

```
cd C:\Users\Giovanni\Downloads\despatch-app
```

```
git add .
```

```
git commit -m "Your message here"
```

```
git push
```

### Database Migration Commands (ONE AT A TIME):

```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
```

```
npx wrangler d1 execute dispatch-db --remote --file=src/db/migration_xyz.sql
```

## Q&A - COMMON QUESTIONS CLAUDE MUST KNOW

### Q: Where is the frontend code?
A: ALL frontend code is in ONE file: `frontend/index.html`. This includes HTML, CSS (in `<style>` tags), and JavaScript (in `<script>` tags). There are NO separate .js or .css files.

### Q: Where is the backend code?
A: In `workers/src/routes/`. Each route file handles a different API area:
- `dispatch.ts` - Daily dispatch operations
- `roster.ts` - Roster management
- `shifts.ts` - Shift template management
- `employees.ts` - Employee/HRM
- `vehicles.ts` - Vehicle fleet

### Q: How do I deploy frontend changes?
A: Git push. Cloudflare Pages auto-deploys from GitHub.
```
cd C:\Users\Giovanni\Downloads\despatch-app
git add .
git commit -m "message"
git push
```

### Q: How do I deploy backend changes?
A: Wrangler deploy.
```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
npx wrangler deploy
```

### Q: What if git push fails with "rejected" error?
A: Remote has newer changes. Run:
```
git pull --rebase
```
Then:
```
git push
```

### Q: How do I run database migrations?
A: Use wrangler d1 execute:
```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
npx wrangler d1 execute dispatch-db --remote --file=src/db/your_migration.sql
```

### Q: What's the API base URL?
A: `https://dispatch-api.oliveri-john001.workers.dev/api`

### Q: How are times stored?
A: Decimal hours. 6.5 = 06:30, 14.25 = 14:15

### Q: What's the tenant ID?
A: `default` (hardcoded, single tenant for now)

### Q: How do I test locally?
A: Currently no local dev setup. Test directly on production (it's a personal project).

## CURRENT APPLICATION STATE

### Completed Modules:
- ✅ HRM (Employees) - Full CRUD
- ✅ Vehicles - Full CRUD
- ✅ Shift Templates - Builder with duty blocks/lines, Gantt preview
- ✅ Roster - Drag-drop assignment, day view
- ✅ Dispatch - Day view with driver/vehicle centric modes

### Dispatch Features (Current):
- Driver-centric and vehicle-centric views
- Real data mode (loads from published rosters)
- Fake data mode (for testing/demo)
- Inline duty editing (time, type, description, location, vehicle, pay)
- Location autocomplete using Nominatim
- Smart vehicle assignment based on location proximity
- Duty line creation for existing roster entries

### In Progress:
- Adhoc shift creation (shifts not from roster templates)
- Charters module

## DATA MODEL

```
Shift Templates (reusable definitions)
  └── Duty Blocks (assignable units, e.g., "AM Block", "PM Block")
       └── Duty Lines (time segments within a block)

Rosters (date range containers)
  └── Roster Entries (assignments: block + date + driver)
       └── Roster Duty Lines (instance-specific overrides of template duty lines)
```

### Key Tables:
- `shift_templates` - Template definitions
- `shift_template_duty_blocks` - Blocks within templates
- `shift_template_duty_lines` - Lines within blocks (TEMPLATE)
- `rosters` - Date range containers
- `roster_entries` - Assignments for specific dates
- `roster_duty_lines` - Instance-specific duty lines (for dispatch edits)

## API ENDPOINTS REFERENCE

### Dispatch
- `GET /api/dispatch/:date` - Get day's dispatch data
- `POST /api/dispatch/assign` - Assign driver/vehicle to entry
- `POST /api/dispatch/transfer` - Transfer entry to different driver
- `POST /api/dispatch/unassign` - Remove assignment
- `POST /api/dispatch/update-duty-line` - Update existing duty line
- `POST /api/dispatch/create-duty-line` - Create new duty line for existing entry

### Roster
- `GET /api/roster/containers` - List rosters
- `GET /api/roster/day/:rosterId/:date` - Get day view
- `POST /api/roster/assign` - Assign block to driver
- `POST /api/roster/unassign` - Remove assignment

### Shifts
- `GET /api/shifts` - List templates
- `GET /api/shifts/:id` - Get template with blocks/lines
- `POST /api/shifts` - Create template
- `PUT /api/shifts/:id` - Update template

## TROUBLESHOOTING

### "404 Not Found" on API calls
- Check endpoint exists in appropriate route file
- Check route is registered in `workers/src/index.ts`
- Redeploy backend: `npx wrangler deploy`

### Changes not showing in browser
- Hard refresh: Ctrl+Shift+R
- Check deployment completed (git push or wrangler deploy)

### Git push rejected
- Run: `git pull --rebase`
- Then: `git push`

### Wrangler deploy fails
- Check you're in `workers` directory
- Run: `npx wrangler login` if auth expired

### Database errors
- Check column exists in schema
- Run migration if needed

## IMPORTANT REMINDERS FOR CLAUDE

1. **ALWAYS give Windows commands LINE BY LINE** - Never use && or ; to chain
2. **Frontend is ONE file** - `frontend/index.html` contains everything
3. **Backend files go in** `workers/src/routes/`
4. **Deploy backend BEFORE frontend** if both changed
5. **User is in Brisbane, QLD** - Australian context for holidays, time zones
6. **Test on production** - No local dev environment
7. **Provide downloadable files** - User downloads then copies manually
8. **After changes, remind user to hard refresh** - Ctrl+Shift+R
