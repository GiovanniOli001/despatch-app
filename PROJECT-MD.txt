# Dispatch App - Complete Project Reference

**Version:** 1.7.0  
**Last Updated:** January 16, 2026  
**Database Schema Verified:** January 16, 2026

---

## âš ï¸ CRITICAL: READ THIS FIRST

**This document is the single source of truth.** Before making ANY changes:
1. Read the relevant sections of this document
2. Follow the Backend Modification Protocol (Section 2)
3. Verify schema before writing SQL (Section 4)
4. Never assume - always verify

---

## SECTION 1: QUICK REFERENCE

### Essential Facts
- **User:** John (Windows PC, Brisbane QLD Australia)
- **Local Project Path:** `C:\Users\Giovanni\Downloads\despatch-app`
- **Frontend:** Modular JS files in `frontend/js/`
- **Backend:** TypeScript files in `workers/src/routes/`
- **Database:** Cloudflare D1 (SQLite)
- **Live App:** https://despatch-app.pages.dev/
- **Live API:** https://dispatch-api.oliveri-john001.workers.dev

### File Structure
```
C:\Users\Giovanni\Downloads\despatch-app\
â”œâ”€â”€ frontend\
â”‚   â”œâ”€â”€ index.html              â† HTML shell + modals
â”‚   â”œâ”€â”€ css\
â”‚   â”‚   â””â”€â”€ main.css            â† All styles (~4,700 lines)
â”‚   â””â”€â”€ js\
â”‚       â”œâ”€â”€ api.js              â† API client
â”‚       â”œâ”€â”€ app.js              â† Constants, nav, utilities
â”‚       â”œâ”€â”€ dispatch.js         â† Dispatch screen (~7,900 lines)
â”‚       â”œâ”€â”€ hrm.js              â† Employees + custom fields
â”‚       â”œâ”€â”€ vehicles.js         â† Vehicle CRUD
â”‚       â”œâ”€â”€ shifts.js           â† Shift templates
â”‚       â””â”€â”€ roster.js           â† Roster + calendar
â””â”€â”€ workers\
    â”œâ”€â”€ wrangler.toml           â† Cloudflare Workers config
    â””â”€â”€ src\
        â”œâ”€â”€ index.ts            â† Main router, CORS, helpers
        â””â”€â”€ routes\
            â”œâ”€â”€ employees.ts
            â”œâ”€â”€ employee-fields.ts
            â”œâ”€â”€ vehicles.ts
            â”œâ”€â”€ shifts.ts
            â”œâ”€â”€ roster.ts
            â”œâ”€â”€ dispatch.ts
            â”œâ”€â”€ dispatch-commit.ts  â† Pay commit functionality
            â”œâ”€â”€ ops-calendar.ts
            â””â”€â”€ config.ts
```

---

## SECTION 2: BACKEND MODIFICATION PROTOCOL

### âš ï¸ LESSONS LEARNED (January 16, 2026)

**What went wrong:** Blind backend edits caused 2+ hours of cascading failures:
- Imported non-existent file â†’ all endpoints failed
- Wrong column names in SQL â†’ constraint errors
- Missing NOT NULL columns â†’ insert failures

**Root causes:**
1. Editing files without seeing current deployed version
2. Writing SQL without verifying actual table schema
3. No TypeScript validation before deploy

### MANDATORY STEPS FOR BACKEND CHANGES

**Step 1: Get Current Source**
Before modifying ANY backend file, ask:
> "Please paste the current content of [filename]"

**Step 2: Verify Schema Before Writing SQL**
```cmd
npx wrangler d1 execute dispatch-db --remote --command="PRAGMA table_info(table_name);"
```

**Step 3: Type Check Before Deploy**
```cmd
cd C:\Users\Giovanni\Downloads\despatch-app\workers
npx tsc --noEmit
```
If this fails, DO NOT DEPLOY.

**Step 4: Monitor Logs During Testing**
```cmd
npx wrangler tail
```
In another terminal, test the endpoint. Only confirm "fixed" after seeing success in logs.

### RULES CLAUDE MUST FOLLOW

| Rule | Description |
|------|-------------|
| âŒ NEVER | Import a file without confirming it exists |
| âŒ NEVER | Write INSERT/UPDATE SQL without verifying column names |
| âŒ NEVER | Say "fixed" until user confirms it works |
| âŒ NEVER | Assume column names from memory |
| âœ… ALWAYS | Ask for current file content for significant backend changes |
| âœ… ALWAYS | Check table schema before writing SQL |
| âœ… ALWAYS | Include tenant_id in INSERT statements |
| âœ… ALWAYS | Check NOT NULL constraints before INSERT |

---

## SECTION 3: DEPLOYMENT PROCEDURES

### Windows Command Rules
**NEVER chain commands with && or ;**
**Give each command in a SEPARATE code block.**

### Backend Deploy
```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
```
```
copy C:\Users\Giovanni\Downloads\[filename].ts src\routes\[filename].ts
```
```
npx wrangler deploy
```

### Frontend Deploy
```
cd C:\Users\Giovanni\Downloads\despatch-app
```
```
copy C:\Users\Giovanni\Downloads\[filename].js frontend\js\[filename].js
```
```
git add .
```
```
git commit -m "Your message"
```
```
git push
```

---

## SECTION 4: DATABASE SCHEMA (VERIFIED January 16, 2026)

### All Tables
```
_cf_KV                              (Cloudflare internal)
audit_log
customers
depots
dispatch_commits                    â† Pay commit tracking
dispatch_duty_cancellations         â† Cancelled duties
duty_types
employee_custom_field_definitions   â† Custom field schema
employee_custom_field_values        â† Custom field data
employee_daily_status
employee_pay_records                â† Generated pay records
employees
locations
pay_types                           â† Pay rate definitions
roster_duties                       (legacy)
roster_duty_lines                   â† Instance duty data
roster_entries                      â† Roster assignments
rosters                             â† Roster containers
routes
shift_template_duty_blocks          â† Duty blocks in templates
shift_template_duty_lines           â† Duty lines in blocks
shift_templates                     â† Reusable shift definitions
tenants
vehicle_daily_status
vehicles
```

### COMPLETE TABLE SCHEMAS

#### employees
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | 'default' |
| depot_id | TEXT | | |
| employee_number | TEXT | YES | |
| first_name | TEXT | YES | |
| last_name | TEXT | YES | |
| email | TEXT | | |
| phone | TEXT | | |
| licence_number | TEXT | | |
| licence_expiry | TEXT | | |
| role | TEXT | | 'driver' |
| status | TEXT | | 'active' |
| hire_date | TEXT | | |
| notes | TEXT | | |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| deleted_at | TEXT | | |
| default_pay_type_id | TEXT | | |

#### vehicles
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | 'default' |
| depot_id | TEXT | | |
| fleet_number | TEXT | YES | |
| rego | TEXT | YES | |
| capacity | INTEGER | YES | |
| make | TEXT | | |
| model | TEXT | | |
| year | INTEGER | | |
| vin | TEXT | | |
| status | TEXT | | 'active' |
| notes | TEXT | | |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| deleted_at | TEXT | | |

#### shift_templates
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | 'default' |
| code | TEXT | YES | |
| name | TEXT | YES | |
| shift_type | TEXT | YES | 'regular' |
| route_id | TEXT | | |
| default_start | REAL | YES | |
| default_end | REAL | YES | |
| default_vehicle_id | TEXT | | |
| notes | TEXT | | |
| is_active | INTEGER | | 1 |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| deleted_at | TEXT | | |

**âš ï¸ COMMON MISTAKE:** Uses `default_start`/`default_end` and `is_active`, NOT `start_time`/`end_time` or `status`

#### shift_template_duty_blocks
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| shift_template_id | TEXT | YES | |
| sequence | INTEGER | YES | |
| name | TEXT | YES | |
| driver_id | TEXT | | |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |

#### shift_template_duty_lines
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| duty_block_id | TEXT | YES | |
| sequence | INTEGER | YES | |
| start_time | REAL | YES | |
| end_time | REAL | YES | |
| duty_type | TEXT | YES | 'driving' |
| description | TEXT | | |
| vehicle_id | TEXT | | |
| pay_type | TEXT | YES | 'STD' |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| location_name | TEXT | | |
| location_lat | REAL | | |
| location_lng | REAL | | |

#### rosters
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | 'default' |
| code | TEXT | YES | |
| name | TEXT | YES | |
| start_date | TEXT | YES | |
| end_date | TEXT | YES | |
| status | TEXT | | 'draft' |
| notes | TEXT | | |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| deleted_at | TEXT | | |
| calendar_start_date | TEXT | | |
| calendar_end_date | TEXT | | |

#### roster_entries
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | 'default' |
| shift_template_id | TEXT | | |
| date | TEXT | YES | |
| name | TEXT | YES | |
| shift_type | TEXT | YES | 'regular' |
| route_id | TEXT | | |
| customer_id | TEXT | | |
| start_time | REAL | YES | |
| end_time | REAL | YES | |
| driver_id | TEXT | | |
| vehicle_id | TEXT | | |
| status | TEXT | | 'scheduled' |
| notes | TEXT | | |
| source | TEXT | | 'manual' |
| source_roster_id | TEXT | | |
| created_at | TEXT | | datetime('now') |
| updated_at | TEXT | | datetime('now') |
| deleted_at | TEXT | | |
| roster_id | TEXT | | |
| duty_block_id | TEXT | | |
| include_in_dispatch | INTEGER | | 0 |

**âš ï¸ COMMON MISTAKE:** Column is `date`, NOT `calendar_date`. Column `name` is NOT NULL.

#### roster_duty_lines
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| roster_entry_id | TEXT | YES | |
| source_duty_line_id | TEXT | | |
| sequence | INTEGER | YES | 1 |
| start_time | REAL | YES | |
| end_time | REAL | YES | |
| duty_type | TEXT | | |
| description | TEXT | | |
| vehicle_id | TEXT | | |
| vehicle_number | TEXT | | |
| pay_type | TEXT | | 'STD' |
| created_at | TEXT | | CURRENT_TIMESTAMP |
| updated_at | TEXT | | CURRENT_TIMESTAMP |
| deleted_at | TEXT | | |
| location_name | TEXT | | |
| location_lat | REAL | | |
| location_lng | REAL | | |

**âš ï¸ COMMON MISTAKE:** `tenant_id` is NOT NULL - must be included in INSERT

#### pay_types
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| code | TEXT | YES | |
| name | TEXT | YES | |
| hourly_rate | REAL | YES | |
| display_order | INTEGER | | 0 |
| is_active | INTEGER | | 1 |
| deleted_at | TEXT | | |
| created_at | TEXT | YES | |
| updated_at | TEXT | YES | |

#### dispatch_commits
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| commit_date | TEXT | YES | |
| scope | TEXT | YES | |
| employee_id | TEXT | | |
| committed_by | TEXT | YES | |
| committed_at | TEXT | YES | |
| notes | TEXT | | |

#### employee_pay_records
| Column | Type | NotNull | Default |
|--------|------|---------|---------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| employee_id | TEXT | YES | |
| work_date | TEXT | YES | |
| shift_template_id | TEXT | | |
| shift_name | TEXT | | |
| duty_block_id | TEXT | | |
| duty_name | TEXT | | |
| pay_type_id | TEXT | | |
| pay_type_code | TEXT | | |
| hours | REAL | YES | |
| rate | REAL | YES | |
| total_amount | REAL | YES | |
| source_duty_line_id | TEXT | | |
| source_type | TEXT | | 'roster' |
| is_manual | INTEGER | | 0 |
| notes | TEXT | | |
| created_at | TEXT | YES | |
| updated_at | TEXT | YES | |

---

## SECTION 5: FOREIGN KEY RELATIONSHIPS

```
shift_templates
    â†‘
    â”‚ shift_template_id
    â”‚
shift_template_duty_blocks â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†‘                                         â”‚
    â”‚ duty_block_id                           â”‚ duty_block_id
    â”‚                                         â”‚
shift_template_duty_lines             roster_entries
                                             â†‘
                                             â”‚ roster_entry_id
                                             â”‚
                                      roster_duty_lines
```

### Deletion Order (CRITICAL!)
1. `roster_duty_lines`
2. `roster_entries`
3. `rosters`
4. `shift_template_duty_lines`
5. `shift_template_duty_blocks`
6. `shift_templates`

---

## SECTION 6: API ENDPOINTS

### Dispatch
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/dispatch/:date` | GET | Full day data |
| `/api/dispatch/assign` | POST | Assign driver/vehicle |
| `/api/dispatch/transfer` | POST | Transfer to different driver |
| `/api/dispatch/unassign` | POST | Remove assignment |
| `/api/dispatch/update-duty-line` | POST | Update duty line |
| `/api/dispatch/create-duty-line` | POST | Create new duty line |
| `/api/dispatch/create-adhoc-shift` | POST | Create adhoc entry |
| `/api/dispatch/cancel-duty-line` | POST | Cancel duty |
| `/api/dispatch/reinstate-duty-line` | POST | Reinstate duty |
| `/api/dispatch/commit-status/:date` | GET | Get commit status |
| `/api/dispatch/pay-records/:date` | GET | Get pay records |
| `/api/dispatch/commit` | POST | Commit day |
| `/api/dispatch/commit/:id` | DELETE | Uncommit |

### Roster
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/roster/containers` | GET | List rosters |
| `/api/roster/containers/:id` | GET | Get roster |
| `/api/roster/containers` | POST | Create roster |
| `/api/roster/containers/:id` | PUT | Update roster |
| `/api/roster/containers/:id/publish` | POST | Publish |
| `/api/roster/containers/:id/unpublish` | POST | Unpublish |
| `/api/roster/assign` | POST | Assign driver |
| `/api/roster/unassign` | POST | Remove assignment |

### Shifts
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/shifts` | GET | List templates |
| `/api/shifts/:id` | GET | Get template |
| `/api/shifts/:id/lock-status` | GET | Check if locked |
| `/api/shifts` | POST | Create template |
| `/api/shifts/:id` | PUT | Update template |
| `/api/shifts/:id` | DELETE | Delete template |

### Employees
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/employees` | GET | List |
| `/api/employees/:id` | GET | Get one |
| `/api/employees` | POST | Create |
| `/api/employees/:id` | PUT | Update |
| `/api/employees/:id` | DELETE | Delete |

### Pay Types
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/pay-types` | GET | List |
| `/api/pay-types` | POST | Create |
| `/api/pay-types/:id` | PUT | Update |

---

## SECTION 7: CURRENT DEVELOPMENT STATUS

### Pay Management Implementation
| Phase | Feature | Status |
|-------|---------|--------|
| 1 | Pay Types Admin | âœ… Complete |
| 2 | Employee Pay Type Association | âœ… Complete |
| 3 | Dispatch Commit | âœ… Complete |
| 4 | Employee Pay Records Tab | ðŸ”„ Next |
| 5 | Reports | Planned |

### Phase 4 Requirements
- New tab on Employee modal: "Pay Records"
- Columns: Date, Shift, Duty, Pay Type, Hours, Rate, Amount, Note
- Filters: Date range, Pay type
- Editable rows (marks as manual adjustment)
- Totals row
- Frozen header

---

## SECTION 8: NEW CHAT HANDOFF

When starting a new chat, tell Claude:

> "Read PROJECT-MD.txt in my project. I'm working on [specific task]. Follow the Backend Modification Protocol before making any backend changes."

Claude should then:
1. Acknowledge reading the document
2. Identify which files need modification
3. Ask for current file content if backend changes needed
4. Verify schema before writing SQL
5. Provide files for download with deployment commands

---

## SECTION 9: VERSION HISTORY

### v1.7.0 (January 16, 2026)
- Restored dispatch commit functionality after accidental removal
- Added comprehensive backend modification protocol
- Full database schema documentation with verified column names
- Lessons learned from cascading failure incident

### v1.6.0 (January 16, 2026)
- Frontend restructured into modular files
- Improved maintainability

### v1.5.0 (January 16, 2026)
- HRM custom fields with layout designer
- Employee modal tabs

### v1.4.0 (January 15, 2026)
- Duty cancellation with visual indicators

### v1.3.0 (January 15, 2026)
- Published roster protection

### v1.2.0 (January 15, 2026)
- Adhoc shift creation

### v1.1.0 (January 2026)
- Roster module with drag-drop
- Dispatch day view

### v1.0.0 (December 2025)
- Initial release
