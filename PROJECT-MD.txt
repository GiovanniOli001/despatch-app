# Dispatch App - Complete Project Reference

**Version:** 1.3.0  
**Last Updated:** January 15, 2026  
**CRITICAL: Claude must read this entire file before making any changes or suggestions.**

---

## SECTION 1: QUICK REFERENCE

### Essential Facts
- **User:** John (Windows PC, Brisbane QLD Australia)
- **Local Project Path:** `C:\Users\Giovanni\Downloads\despatch-app`
- **Frontend:** Single HTML file at `frontend/index.html`
- **Backend:** TypeScript files in `workers/src/routes/`
- **Database:** Cloudflare D1 (SQLite)
- **Live App:** https://despatch-app.pages.dev/
- **Live API:** https://dispatch-api.oliveri-john001.workers.dev

### File Structure
```
C:\Users\Giovanni\Downloads\despatch-app\
├── frontend\
│   └── index.html              ← ALL frontend code (HTML + CSS + JS in one file)
└── workers\
    ├── wrangler.toml           ← Cloudflare Workers config
    └── src\
        ├── index.ts            ← Main router, CORS, helpers
        ├── routes\
        │   ├── employees.ts    ← Employee/HRM API
        │   ├── vehicles.ts     ← Vehicle fleet API
        │   ├── shifts.ts       ← Shift templates API
        │   ├── roster.ts       ← Roster management API
        │   ├── dispatch.ts     ← Daily dispatch API
        │   ├── ops-calendar.ts ← Operations calendar API
        │   └── config.ts       ← Config endpoints
        └── db\
            └── schema.sql      ← Database schema
```

---

## SECTION 2: DEPLOYMENT PROCEDURES

**CRITICAL: On Windows, NEVER chain commands with && or ;**
**Give each command in a SEPARATE code block.**

### Workflow
1. Claude provides downloadable files
2. User downloads files to `C:\Users\Giovanni\Downloads\`
3. User runs copy commands (one at a time)
4. User deploys backend (if changed): `npx wrangler deploy`
5. User deploys frontend (if changed): `git add . && git commit && git push`

### Backend Deploy (ONE AT A TIME):
```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
```
```
npx wrangler deploy
```

### Frontend Deploy (ONE AT A TIME):
```
cd C:\Users\Giovanni\Downloads\despatch-app
```
```
git add .
```
```
git commit -m "Your message here"
```
```
git push
```

### Database Commands (ONE AT A TIME):

List all tables:
```
npx wrangler d1 execute dispatch-db --remote --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
```

---

## SECTION 3: DATABASE SCHEMA (CRITICAL)

**IMPORTANT: Understand foreign key relationships before modifying data!**

### Complete Table List
```
_cf_KV                         (Cloudflare internal)
audit_log
customers
depots
duty_types
employee_daily_status
employees
locations
pay_types
roster_duties                  (legacy - may be empty)
roster_duty_lines              ← Instance-specific duty data
roster_entries                 ← Assignments (block + date + driver)
rosters                        ← Roster containers
routes
shift_template_duty_blocks     ← Duty blocks within templates
shift_template_duty_lines      ← Duty lines within blocks
shift_templates                ← Reusable shift definitions
tenants
vehicle_daily_status
vehicles
```

### Foreign Key Relationships (CRITICAL!)

```
shift_templates
    ↑
    │ shift_template_id
    │
shift_template_duty_blocks ←───────────────┐
    ↑                                      │
    │ duty_block_id                        │ duty_block_id
    │                                      │
shift_template_duty_lines          roster_entries
                                          ↑
                                          │ roster_entry_id
                                          │
                                   roster_duty_lines
```

**DELETION ORDER (must follow to avoid FK errors):**
1. `roster_duty_lines` (references roster_entries)
2. `roster_entries` (references shift_template_duty_blocks, rosters)
3. `rosters`
4. `shift_template_duty_lines` (references shift_template_duty_blocks)
5. `shift_template_duty_blocks` (references shift_templates)
6. `shift_templates`

### Table Definitions

**shift_templates**
```sql
CREATE TABLE shift_templates (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    code TEXT NOT NULL,              -- e.g., "EARLY-001"
    name TEXT NOT NULL,              -- e.g., "Early Morning Shift"
    shift_type TEXT DEFAULT 'regular',
    default_start REAL,              -- Decimal hours
    default_end REAL,
    notes TEXT,
    is_active INTEGER DEFAULT 1,
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**shift_template_duty_blocks**
```sql
CREATE TABLE shift_template_duty_blocks (
    id TEXT PRIMARY KEY,
    shift_template_id TEXT NOT NULL REFERENCES shift_templates(id),
    sequence INTEGER NOT NULL,
    name TEXT NOT NULL,              -- e.g., "Duty 1", "AM Block"
    driver_id TEXT REFERENCES employees(id),  -- Default driver (optional)
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**shift_template_duty_lines**
```sql
CREATE TABLE shift_template_duty_lines (
    id TEXT PRIMARY KEY,
    duty_block_id TEXT NOT NULL REFERENCES shift_template_duty_blocks(id),
    sequence INTEGER NOT NULL,
    start_time REAL NOT NULL,        -- Decimal hours (6.5 = 06:30)
    end_time REAL NOT NULL,
    duty_type TEXT NOT NULL DEFAULT 'driving',
    description TEXT,
    vehicle_id TEXT REFERENCES vehicles(id),
    pay_type TEXT NOT NULL DEFAULT 'STD',
    location_name TEXT,
    location_lat REAL,
    location_lng REAL,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**rosters**
```sql
CREATE TABLE rosters (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    code TEXT NOT NULL UNIQUE,       -- e.g., "WK03-JAN26"
    name TEXT NOT NULL,
    start_date TEXT NOT NULL,        -- ISO date
    end_date TEXT NOT NULL,
    status TEXT DEFAULT 'draft',     -- draft, scheduled, published
    calendar_start_date TEXT,        -- When scheduled to ops calendar
    calendar_end_date TEXT,
    notes TEXT,
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**roster_entries**
```sql
CREATE TABLE roster_entries (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    roster_id TEXT REFERENCES rosters(id),           -- NULL for adhoc
    shift_template_id TEXT REFERENCES shift_templates(id),  -- NULL for adhoc
    duty_block_id TEXT REFERENCES shift_template_duty_blocks(id),
    date TEXT NOT NULL,
    name TEXT NOT NULL,
    shift_type TEXT DEFAULT 'regular',
    start_time REAL,
    end_time REAL,
    driver_id TEXT REFERENCES employees(id),
    status TEXT DEFAULT 'scheduled',
    source TEXT DEFAULT 'manual',
    include_in_dispatch INTEGER DEFAULT 0,
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**roster_duty_lines**
```sql
CREATE TABLE roster_duty_lines (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    roster_entry_id TEXT NOT NULL REFERENCES roster_entries(id),
    source_duty_line_id TEXT,        -- Original template line ID
    sequence INTEGER NOT NULL,
    start_time REAL NOT NULL,
    end_time REAL NOT NULL,
    duty_type TEXT NOT NULL DEFAULT 'driving',
    description TEXT,
    vehicle_id TEXT REFERENCES vehicles(id),
    vehicle_number TEXT,             -- Denormalized for display
    pay_type TEXT NOT NULL DEFAULT 'STD',
    location_name TEXT,
    location_lat REAL,
    location_lng REAL,
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**employees**
```sql
CREATE TABLE employees (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    employee_number TEXT,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    email TEXT,
    phone TEXT,
    role TEXT DEFAULT 'driver',      -- driver, admin, etc.
    status TEXT DEFAULT 'active',
    licence_number TEXT,
    licence_expiry TEXT,
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**vehicles**
```sql
CREATE TABLE vehicles (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    fleet_number TEXT NOT NULL,      -- e.g., "BUS-001"
    registration TEXT,
    make TEXT,
    model TEXT,
    year INTEGER,
    capacity INTEGER,
    status TEXT DEFAULT 'active',
    deleted_at TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

### Purge Data Commands (Safe Order)

To purge all roster/shift data:
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM roster_duty_lines;"
```
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM roster_entries;"
```
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM rosters;"
```
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM shift_template_duty_lines;"
```
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM shift_template_duty_blocks;"
```
```
npx wrangler d1 execute dispatch-db --remote --command="DELETE FROM shift_templates;"
```

---

## SECTION 4: ROSTER & DISPATCH WORKFLOW

### Roster Statuses
- **draft** - Initial state, editable
- **scheduled** - Assigned to ops calendar dates, editable
- **published** - Live in dispatch, NOT editable

### Published Roster Protections
When a roster is **published**:
1. **Shifts cannot be edited** - Frontend checks lock status, backend returns 403
2. **Shifts cannot be deleted** - Backend returns 403
3. **Roster cannot be edited** - Frontend blocks, backend returns 403
4. **Roster cannot be opened** - Open button shows toast message

### Unpublishing a Roster
- Removes all duties from Dispatch view
- Reverts status to 'draft'
- User sees warning: "This will remove all duties from Dispatch"

### Data Flow
```
1. Create Shift Template (with duty blocks/lines)
           ↓
2. Create Roster (date range container)
           ↓
3. Open Roster → Drag blocks to drivers (creates roster_entries)
           ↓
4. Schedule Roster to Ops Calendar
           ↓
5. Publish Roster → Duties appear in Dispatch
           ↓
6. Edit duties in Dispatch (updates roster_duty_lines)
```

### Editing Shifts with Roster References
When updating a shift template that has been used in rosters:
1. Delete roster_duty_lines for affected roster_entries
2. Delete roster_entries referencing the duty blocks
3. Delete shift_template_duty_lines
4. Delete shift_template_duty_blocks
5. Insert new blocks and lines

**This cascading delete is necessary due to foreign key constraints!**

---

## SECTION 5: API ENDPOINTS

### Dispatch
- `GET /api/dispatch/:date` - Get day's dispatch data
- `POST /api/dispatch/assign` - Assign driver/vehicle
- `POST /api/dispatch/transfer` - Transfer to different driver/vehicle
- `POST /api/dispatch/unassign` - Remove assignment
- `POST /api/dispatch/update-duty-line` - Update existing duty line
- `POST /api/dispatch/create-duty-line` - Create new duty line for existing entry
- `POST /api/dispatch/create-adhoc-shift` - Create adhoc roster entry with duty

### Roster
- `GET /api/roster/containers` - List all rosters
- `GET /api/roster/containers/:id` - Get roster details
- `POST /api/roster/containers` - Create roster
- `PUT /api/roster/containers/:id` - Update roster (blocked if published)
- `DELETE /api/roster/containers/:id` - Soft delete
- `POST /api/roster/containers/:id/schedule` - Schedule to ops calendar
- `POST /api/roster/containers/:id/unschedule` - Remove from ops calendar
- `POST /api/roster/containers/:id/publish` - Publish to dispatch
- `POST /api/roster/containers/:id/unpublish` - Remove from dispatch
- `GET /api/roster/day/:rosterId/:date` - Get day view
- `POST /api/roster/assign` - Assign block to driver
- `POST /api/roster/unassign` - Remove assignment

### Shift Templates
- `GET /api/shifts` - List templates
- `GET /api/shifts/:id` - Get template with blocks/lines
- `GET /api/shifts/:id/lock-status` - Check if locked by published rosters
- `POST /api/shifts` - Create template
- `PUT /api/shifts/:id` - Update template (blocked if in published roster)
- `DELETE /api/shifts/:id` - Soft delete (blocked if in published roster)
- `POST /api/shifts/:id/duplicate` - Duplicate template

### Employees
- `GET /api/employees` - List
- `POST /api/employees` - Create
- `PUT /api/employees/:id` - Update
- `DELETE /api/employees/:id` - Soft delete

### Vehicles
- `GET /api/vehicles` - List
- `POST /api/vehicles` - Create
- `PUT /api/vehicles/:id` - Update
- `DELETE /api/vehicles/:id` - Soft delete

---

## SECTION 6: TIME FORMAT & TYPES

### Time Format
- **Decimal hours**: 6.5 = 06:30, 14.25 = 14:15, 23.75 = 23:45
- Stored as REAL in SQLite

### Duty Types
| Code | Label | Description |
|------|-------|-------------|
| driving | D | Driving with vehicle |
| oov | OOV | Out of vehicle work |
| break | BRK | Meal/rest break |
| waiting | WAIT | Waiting time |
| charter | CHR | Charter work |
| dead | DEAD | Dead running |

### Pay Types
| Code | Label | Multiplier |
|------|-------|------------|
| STD | Standard | 1.0x |
| OT | Overtime | 1.5x |
| DT | Double Time | 2.0x |
| PEN | Penalty Rate | 1.25x |

---

## SECTION 7: CONFLICT DETECTION

### Roster Assignment Conflicts
When assigning a driver to a duty block, check for:
1. Same date
2. Same driver  
3. Overlapping times
4. **Exclude deleted roster entries** (`re.deleted_at IS NULL`)
5. **Exclude deleted rosters** (`r.deleted_at IS NULL`)
6. **Exclude deleted shift templates** (`st.deleted_at IS NULL`)

---

## SECTION 8: REMINDERS FOR CLAUDE

1. **ALWAYS give Windows commands LINE BY LINE** - Never use && or ;
2. **Frontend is ONE file** - `frontend/index.html`
3. **UNDERSTAND FK RELATIONSHIPS** before modifying/deleting data
4. **Deletion order matters** - roster_duty_lines → roster_entries → etc.
5. **Published rosters block edits** - Check status before modifications
6. **Soft deletes only** - Set deleted_at, never hard delete
7. **Always check deleted_at IS NULL** in queries
8. **Times are decimal hours** - 6.5 = 06:30
9. **User is in Brisbane, QLD** - Australian context

---

## SECTION 9: VERSION HISTORY

### v1.3.0 (January 15, 2026)
- Published roster protection (shifts, rosters locked when published)
- Fixed shift editing foreign key errors (cascading delete)
- Fixed bulk vehicle assignment (Assign All saves to database)
- Fixed driver_id not saving on shift edit
- Ops Calendar with publish/unpublish

### v1.2.0 (January 15, 2026)
- Adhoc shift creation with database persistence
- Location autocomplete fixes

### v1.1.0 (January 2026)
- Roster module with drag-drop
- Dispatch day view with inline editing

### v1.0.0 (December 2025)
- Initial release with HRM, Vehicles, Shift Templates
