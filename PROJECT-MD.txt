# Dispatch App - Complete Project Reference

**Version:** 1.9.0  
**Last Updated:** January 18, 2026  
**Database Schema Verified:** January 17, 2026

---

## ðŸš¨ ABSOLUTE RULE: ALWAYS REQUEST CURRENT FILES

**Claude must NEVER use files from memory or previous context.**

Before ANY code work, Claude MUST ask:
> "Please upload the current version of [filename] from your project folder."

This applies to:
- ANY file being modified
- ANY file being referenced for context
- Even if a file was uploaded earlier in the same conversation

**Why:** Files change during deployment. Using stale files causes bugs, conflicts, and wasted time.

**No exceptions. No assumptions. Always ask.**

---

## âš ï¸ CRITICAL: READ THIS FIRST

**This document is the single source of truth.** Before making ANY changes:
1. **REQUEST CURRENT FILES** (see rule above)
2. Read the relevant sections of this document
3. Follow the Backend Modification Protocol (Section 2)
4. Verify schema using schema-reference.sql (Section 4)
5. Never assume - always verify

---

## SECTION 1: QUICK REFERENCE

### Essential Facts
- **User:** John (Windows PC, Brisbane QLD Australia)
- **Local Project Path:** `C:\Users\Giovanni\Downloads\despatch-app`
- **Frontend:** Modular JS files in `frontend/js/`
- **Backend:** TypeScript files in `workers/src/routes/`
- **Database:** Cloudflare D1 (SQLite)
- **Live App:** https://despatch-app.pages.dev/
- **Live API:** https://dispatch-api.oliveri-john001.workers.dev

### File Structure
```
C:\Users\Giovanni\Downloads\despatch-app\
â”œâ”€â”€ frontend\
â”‚   â”œâ”€â”€ index.html              â† HTML shell + modals
â”‚   â”œâ”€â”€ css\
â”‚   â”‚   â””â”€â”€ main.css            â† All styles (~4,700 lines)
â”‚   â””â”€â”€ js\
â”‚       â”œâ”€â”€ api.js              â† API client
â”‚       â”œâ”€â”€ app.js              â† Constants, nav, utilities
â”‚       â”œâ”€â”€ dispatch.js         â† Dispatch screen (~8,000 lines)
â”‚       â”œâ”€â”€ hrm.js              â† Employees + custom fields
â”‚       â”œâ”€â”€ vehicles.js         â† Vehicle CRUD
â”‚       â”œâ”€â”€ shifts.js           â† Shift templates
â”‚       â””â”€â”€ roster.js           â† Roster + calendar
â”œâ”€â”€ workers\
â”‚   â”œâ”€â”€ wrangler.toml           â† Cloudflare Workers config
â”‚   â””â”€â”€ src\
â”‚       â”œâ”€â”€ index.ts            â† Main router, CORS, helpers
â”‚       â””â”€â”€ routes\
â”‚           â”œâ”€â”€ employees.ts
â”‚           â”œâ”€â”€ employee-fields.ts
â”‚           â”œâ”€â”€ vehicles.ts
â”‚           â”œâ”€â”€ shifts.ts
â”‚           â”œâ”€â”€ roster.ts
â”‚           â”œâ”€â”€ dispatch.ts
â”‚           â”œâ”€â”€ dispatch-commit.ts  â† Pay commit functionality
â”‚           â”œâ”€â”€ ops-calendar.ts
â”‚           â””â”€â”€ config.ts
â”œâ”€â”€ PROJECT-MD.txt              â† This file
â”œâ”€â”€ README.md                   â† Quick reference
â””â”€â”€ schema-reference.sql        â† Database schema (keep updated!)
```

---

## SECTION 2: BACKEND MODIFICATION PROTOCOL

### âš ï¸ LESSONS LEARNED (January 16-18, 2026)

**What went wrong:** 
- Blind backend edits caused cascading failures
- Using stale files from memory caused variable conflicts
- Wrong API endpoints due to not checking existing code

**Root causes:**
1. Editing files without seeing current deployed version
2. Writing SQL without verifying actual table schema
3. Using files from earlier in conversation instead of requesting fresh uploads

### MANDATORY STEPS FOR ANY CODE CHANGES

**Step 0: Request Current File**
> "Please upload the current version of [filename]"

**NEVER skip this step. NEVER use files from memory.**

**Step 1: Verify Schema Before Writing SQL**
Check schema-reference.sql first, then verify:
```cmd
npx wrangler d1 execute dispatch-db --remote --command="PRAGMA table_info(table_name);"
```

**Step 2: Type Check Before Deploy**
```cmd
cd C:\Users\Giovanni\Downloads\despatch-app\workers
npx tsc --noEmit
```
If this fails, DO NOT DEPLOY.

**Step 3: Monitor Logs During Testing**
```cmd
npx wrangler tail
```

### RULES CLAUDE MUST FOLLOW

| Rule | Description |
|------|-------------|
| âŒ NEVER | Use a file from memory or earlier in conversation |
| âŒ NEVER | Modify code without requesting current file first |
| âŒ NEVER | Import a file without confirming it exists |
| âŒ NEVER | Write INSERT/UPDATE SQL without verifying column names |
| âŒ NEVER | Say "fixed" until user confirms it works |
| âŒ NEVER | Assume column names from memory |
| âœ… ALWAYS | Request current file before ANY code changes |
| âœ… ALWAYS | Ask for ALL affected files upfront |
| âœ… ALWAYS | Check table schema before writing SQL |
| âœ… ALWAYS | Include tenant_id in INSERT statements |
| âœ… ALWAYS | Check NOT NULL constraints before INSERT |

---

## SECTION 3: DEPLOYMENT PROCEDURES

### Windows Command Rules
**NEVER chain commands with && or ;**
**Give each command in a SEPARATE code block.**

### Backend Deploy
```
cd C:\Users\Giovanni\Downloads\despatch-app\workers
```
```
copy C:\Users\Giovanni\Downloads\[filename].ts src\routes\[filename].ts
```
```
npx tsc --noEmit
```
```
npx wrangler deploy
```

### Frontend Deploy
```
cd C:\Users\Giovanni\Downloads\despatch-app
```
```
copy C:\Users\Giovanni\Downloads\[filename].js frontend\js\[filename].js
```
```
git add .
```
```
git commit -m "Your message"
```
```
git push
```

---

## SECTION 4: DATABASE SCHEMA

### Schema Maintenance
The file `schema-reference.sql` in the project root contains the complete database schema.

**When to update schema-reference.sql:**
- After any `ALTER TABLE` command
- After any `CREATE TABLE` command
- After adding/removing columns

**To regenerate from live database:**
```cmd
npx wrangler d1 execute dispatch-db --remote --command=".schema" > schema-output.txt
```

### All Tables
```
_cf_KV                              (Cloudflare internal)
audit_log
customers
depots
dispatch_adhoc_duty_lines           â† Adhoc duty lines (standalone)
dispatch_adhoc_shifts               â† Adhoc shifts (standalone, no roster/template)
dispatch_commits                    â† Pay commit tracking
dispatch_duty_cancellations         â† Cancelled duties
duty_types
employee_custom_field_definitions   â† Custom field schema
employee_custom_field_values        â† Custom field data
employee_daily_status
employee_pay_records                â† Generated pay records
employees
locations
pay_types                           â† Pay rate definitions
roster_duties                       (legacy)
roster_duty_lines                   â† Instance duty data
roster_entries                      â† Roster assignments
rosters                             â† Roster containers
routes
shift_template_duty_blocks          â† Duty blocks in templates
shift_template_duty_lines           â† Duty lines in blocks
shift_templates                     â† Reusable shift definitions
tenants
vehicle_daily_status
vehicles
```

### Key Table Schemas

#### roster_duty_lines
| Column | Type | NotNull | Description |
|--------|------|---------|-------------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| roster_entry_id | TEXT | YES | FK to roster_entries |
| source_duty_line_id | TEXT | | FK to shift_template_duty_lines (NULL = user-added) |
| sequence | INTEGER | | |
| start_time | REAL | | Hours (e.g., 6.5 = 6:30am) |
| end_time | REAL | | |
| duty_type | TEXT | | |
| description | TEXT | | |
| vehicle_id | TEXT | | |
| vehicle_number | TEXT | | |
| pay_type | TEXT | | Default 'STD' |
| location_name | TEXT | | |
| location_lat | REAL | | |
| location_lng | REAL | | |
| created_at | TEXT | | |
| updated_at | TEXT | | |
| deleted_at | TEXT | | |

**âš ï¸ IMPORTANT:** `source_duty_line_id` distinguishes template-sourced vs user-added duties:
- `NOT NULL` = copied from shift template
- `NULL` = user added inline duty

#### roster_entries
| Column | Type | NotNull | Description |
|--------|------|---------|-------------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| roster_id | TEXT | YES | FK to rosters |
| shift_template_id | TEXT | | FK to shift_templates |
| duty_block_id | TEXT | | FK to shift_template_duty_blocks |
| date | TEXT | YES | |
| name | TEXT | | |
| start_time | REAL | | |
| end_time | REAL | | |
| driver_id | TEXT | | FK to employees |
| vehicle_id | TEXT | | FK to vehicles |
| status | TEXT | | |
| source | TEXT | | |
| include_in_dispatch | INTEGER | | 0 or 1 |
| created_at | TEXT | | |
| updated_at | TEXT | | |
| deleted_at | TEXT | | |

#### rosters
| Column | Type | NotNull | Description |
|--------|------|---------|-------------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| code | TEXT | YES | Unique code |
| name | TEXT | YES | |
| start_date | TEXT | YES | Roster valid from |
| end_date | TEXT | YES | Roster valid to |
| calendar_start_date | TEXT | | Scheduled on calendar from |
| calendar_end_date | TEXT | | Scheduled on calendar to |
| status | TEXT | | 'draft' or 'published' |
| notes | TEXT | | |
| created_at | TEXT | | |
| updated_at | TEXT | | |
| deleted_at | TEXT | | |

#### pay_types
| Column | Type | NotNull | Description |
|--------|------|---------|-------------|
| id | TEXT | PK | |
| tenant_id | TEXT | YES | |
| code | TEXT | YES | e.g., 'STD', 'OT' |
| name | TEXT | YES | e.g., 'Standard', 'Overtime' |
| multiplier | REAL | | Default 1.0 |
| is_active | INTEGER | | 0 or 1 |
| sort_order | INTEGER | | |
| created_at | TEXT | | |
| updated_at | TEXT | | |

### Foreign Key Deletion Order
When purging data, delete in this order:
1. `roster_duty_lines`
2. `roster_entries`
3. `rosters`
4. `shift_template_duty_lines`
5. `shift_template_duty_blocks`
6. `shift_templates`
7. `dispatch_adhoc_duty_lines`
8. `dispatch_adhoc_shifts`

---

## SECTION 5: IMPORTANT BUSINESS LOGIC

### Roster State Management
- **Roster assignments** (driver_id on roster_entries) are USER-CONTROLLED
- **Clear Despatch** removes calendar scheduling but PRESERVES roster assignments
- **Unpublish** reverts to draft but PRESERVES roster assignments and user-added duties
- **Remove from calendar** only clears calendar dates, preserves everything else

### Inline Duties
- User can add duties in Dispatch using + buttons
- These create `roster_duty_lines` with `source_duty_line_id = NULL`
- Unpublish MUST preserve these (only delete where source_duty_line_id IS NOT NULL)
- Republish recreates template duties while keeping user-added ones

### Lockout Logic
- **Published rosters:** Cannot edit shift templates, cannot open roster for editing
- **Scheduled rosters:** Cannot delete, cannot open for editing
- Both frontend (roster.js) and backend (roster.ts) enforce lockouts

---

## SECTION 6: API ENDPOINTS

### Pay Types
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/pay-types` | GET | List all pay types |
| `/api/pay-types` | POST | Create pay type |
| `/api/pay-types/:id` | PUT | Update pay type |

**Note:** Endpoint is `/pay-types` NOT `/config/pay-types`

### Dispatch
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/dispatch/:date` | GET | Get day's dispatch data |
| `/api/dispatch/commit` | POST | Commit day to payroll |
| `/api/dispatch/create-duty-line` | POST | Create inline duty |
| `/api/dispatch/update-duty-line` | POST | Update duty |
| `/api/dispatch/cancel-duty-line` | POST | Cancel duty |
| `/api/dispatch/create-adhoc-shift` | POST | Create adhoc shift |

### Roster
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/roster/containers` | GET | List rosters |
| `/api/roster/containers/:id` | GET | Get roster |
| `/api/roster/containers` | POST | Create roster |
| `/api/roster/containers/:id` | PUT | Update roster |
| `/api/roster/containers/:id` | DELETE | Delete roster (with lockout checks) |
| `/api/roster/containers/:id/publish` | POST | Publish |
| `/api/roster/containers/:id/unpublish` | POST | Unpublish |
| `/api/roster/containers/:id/schedule` | POST | Add to calendar |
| `/api/roster/containers/:id/unschedule` | POST | Remove from calendar |

---

## SECTION 7: CURRENT DEVELOPMENT STATUS

### v1.9.0 Progress (January 18, 2026)

| Task | Status |
|------|--------|
| P1.1 Unpublish preserving inline duties | âœ… Complete |
| P1.2 Pay types from API (dispatch + shifts) | âœ… Complete |
| P1.3 Roster delete lockout | âœ… Complete |
| P1.4 Roster open lockout | âœ… Complete |
| P1.5 Clear Despatch preserving assignments | âœ… Complete |
| P1.6 HRM page loading fix | âœ… Complete |
| P2.1 Remove uncommit feature | âœ… Complete |
| P2.2 Additive-only commits | âœ… Complete |
| P2.3 Show last committed timestamp | âœ… Complete |
| P3.1 Larger employee edit modal | âœ… Complete |
| P3.2 Pay record notes rework | âœ… Complete |
| P4.1 Custom Fields button | âœ… Complete |
| P4.2 Operations Calendar filters | âœ… Complete |
| P4.3 Rosters screen force refresh | âœ… Complete |
| P4.4 Processing loading indicator | âœ… Complete |
| P4.5 Consistent confirmation modals | âœ… Complete |
| P5 Code cleanup | ðŸ”„ Next |

See PROJECT-PLAN-2026-01-18.md for full details.

---

## SECTION 8: NEW CHAT HANDOFF

When starting a new chat, tell Claude:

> "Read PROJECT-MD.txt in my project. I'm working on [specific task]. You must request current files before making any code changes - never use files from memory."

Claude should then:
1. Acknowledge reading the document
2. Identify which files need modification
3. **REQUEST CURRENT FILES** (mandatory, no exceptions)
4. Verify schema before writing SQL
5. Provide files for download with deployment commands

---

## SECTION 9: VERSION HISTORY

### v1.9.0 (January 18, 2026)
- **P1 Bug Fixes:**
  - Unpublish now preserves user-added inline duties
  - Pay types fetched from API in dispatch and shift templates
  - Roster delete blocked when scheduled on calendar
  - Roster open blocked when scheduled on calendar
  - Clear Despatch preserves roster assignments
  - HRM page loading fixed (variable conflict resolved)
- **P2 Commit System Rework:**
  - Removed uncommit feature (prevents data integrity issues)
  - Additive-only commits (re-commit updates timestamp, only adds new records)
  - Cancelled duties excluded from commits
  - Shows "Last committed: DD/MM/YYYY HH:MM" format
- **P3 HRM Enhancements:**
  - Larger employee edit modal (900px width)
  - Pay record notes rework - multi-note with timestamps, icon display
- **P4 UI/UX Improvements:**
  - Custom Fields button replaces cog icon
  - Operations Calendar filters (All/This Month/Published/Draft)
  - Rosters screen always resets to list view
  - Full-screen processing overlay for publish/unpublish
  - Consistent confirmation modals (replaced 11 browser confirm() calls)
- Added explicit file request requirements to documentation
- Added schema-reference.sql for schema maintenance

### v1.8.0 (January 17, 2026)
- **Adhoc shift refactoring** - Standalone tables (dispatch_adhoc_shifts, dispatch_adhoc_duty_lines)
- Adhoc shifts no longer create fake roster/template records
- All dispatch operations support adhoc shifts
- Fixed inline duty insertion time calculation bug

### v1.7.0 (January 16, 2026)
- Restored dispatch commit functionality
- Added comprehensive backend modification protocol
- Full database schema documentation

### v1.6.0 (January 16, 2026)
- Frontend restructured into modular files

### v1.5.0 (January 16, 2026)
- HRM custom fields with layout designer

### v1.4.0 (January 15, 2026)
- Duty cancellation with visual indicators

### v1.3.0 (January 15, 2026)
- Published roster protection

### v1.2.0 (January 15, 2026)
- Adhoc shift creation

### v1.1.0 (January 2026)
- Roster module with drag-drop

### v1.0.0 (December 2025)
- Initial release
