<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dispatch App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
</head>
<body class="style-b">
  <header class="header">
    <div class="header-left">
      <button class="menu-toggle" id="menuToggle" onclick="toggleNavSidebar()">Menu</button>
      <div class="logo">DESPATCH//</div>
      <div class="date-nav">
        <button onclick="changeDate(-1)">‚óÄ</button>
        <span class="current-date" id="currentDate">Mon 14 Jul 2025</span>
        <button onclick="changeDate(1)">‚ñ∂</button>
      </div>
      <div class="style-toggle">
        <span class="style-toggle-label">Data:</span>
        <select class="style-select" id="dataSourceSelect" onchange="changeDataSource()">
          <option value="fake">üé≠ Fake Data</option>
          <option value="real">üîå Real API</option>
        </select>
      </div>
      <div class="style-toggle">
        <span class="style-toggle-label">Style:</span>
        <select class="style-select" id="styleSelect" onchange="changeStyle()">
          <option value="style-a">A: Original (Fragmented)</option>
          <option value="style-b" selected>B: Unified + Segments</option>
          <option value="style-c">C: Gradient/Opacity</option>
          <option value="style-d">D: Outline</option>
          <option value="style-e">E: Modern Pill</option>
        </select>
      </div>
      <div class="style-toggle">
        <span class="style-toggle-label">Primary:</span>
        <select class="style-select" id="allocationMode" onchange="changeAllocationMode()">
          <option value="driver">Driver ‚Üí Vehicle</option>
          <option value="vehicle">Vehicle ‚Üí Driver</option>
        </select>
      </div>
      <div class="style-toggle">
        <span class="style-toggle-label">View:</span>
        <select class="style-select" id="viewMode" onchange="changeViewMode()">
          <option value="horizontal">Horizontal</option>
          <option value="vertical">Vertical</option>
        </select>
      </div>
    </div>
    <div class="header-right">
      <button class="btn-ai" onclick="toggleAIAssistant()">
        Batman
      </button>
      <button class="btn-primary" onclick="showToast('Charter creation coming soon')">
        + Charter
      </button>
    </div>
  </header>
  
  <!-- AI Assistant Modal -->
  <div class="ai-modal-overlay" id="aiModalOverlay" onclick="toggleAIAssistant()"></div>
  <div class="ai-assistant" id="aiAssistant">
    <div class="ai-header">
      <div class="ai-title">Batman</div>
      <button class="ai-close" onclick="toggleAIAssistant()">‚úï</button>
    </div>
    <div class="ai-messages" id="aiMessages">
      <div class="ai-message assistant">
        <div class="ai-message-content">
          I'm Batman. I watch over this dispatch board. Ask me anything:
          <ul style="margin: 8px 0 0 16px; font-size: 12px;">
            <li>"Who's available between 14:00 and 18:00?"</li>
            <li>"Which vehicles have capacity over 50?"</li>
            <li>"Summarise today's dispatch"</li>
            <li>"Any drivers approaching overtime?"</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="aiInput" 
             placeholder="Signal Batman..." 
             onkeydown="if(event.key==='Enter')sendAIQuery()">
      <button class="ai-send" onclick="sendAIQuery()">Send</button>
    </div>
    <div class="ai-footer">The Dark Knight watches over your fleet</div>
  </div>

  <div class="app-container">
    <!-- Navigation Sidebar -->
    <nav class="nav-sidebar" id="navSidebar">
      <div class="nav-section">
        <div class="nav-section-title">Operations</div>
        <a class="nav-item active" onclick="navigateTo('dispatch')" data-screen="dispatch">
          <span class="nav-label">Dispatch</span>
        </a>
        <a class="nav-item" onclick="navigateTo('calendar')" data-screen="calendar">
          <span class="nav-label">Operations Calendar</span>
        </a>
        <a class="nav-item" onclick="navigateTo('charters')" data-screen="charters">
          <span class="nav-label">Charters</span>
        </a>
        <a class="nav-item" onclick="navigateTo('customers')" data-screen="customers">
          <span class="nav-label">Customers</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Resources</div>
        <a class="nav-item" onclick="navigateTo('hrm')" data-screen="hrm">
          <span class="nav-label">HRM</span>
        </a>
        <a class="nav-item" onclick="navigateTo('vehicles')" data-screen="vehicles">
          <span class="nav-label">Vehicles</span>
        </a>
        <a class="nav-item" onclick="navigateTo('shifts')" data-screen="shifts">
          <span class="nav-label">Shift Templates</span>
        </a>
        <a class="nav-item" onclick="navigateTo('roster')" data-screen="roster">
          <span class="nav-label">Roster</span>
        </a>
        <a class="nav-item" onclick="navigateTo('maintenance')" data-screen="maintenance">
          <span class="nav-label">Maintenance</span>
        </a>
      </div>
      <div class="nav-toggle">
        <button class="nav-toggle-btn" onclick="toggleNavSidebar()">
          Hide Menu
        </button>
      </div>
    </nav>
    
    <!-- Main App Body -->
    <div class="app-body">
      <!-- Dispatch Screen -->
      <div class="screen" id="screen-dispatch">
        <div class="stats-bar">
          <div class="stat-item">
            <div class="stat-indicator green"></div>
            <span class="stat-label">Drivers Available</span>
            <span class="stat-value" id="statDriversAvail">28</span>
          </div>
          <div class="stat-item">
            <div class="stat-indicator blue"></div>
            <span class="stat-label">Drivers Working</span>
            <span class="stat-value" id="statDriversWork">64</span>
          </div>
          <div class="stat-item">
            <div class="stat-indicator red"></div>
            <span class="stat-label">On Leave</span>
            <span class="stat-value" id="statDriversLeave">12</span>
          </div>
          <div class="stat-item">
            <div class="stat-indicator green"></div>
            <span class="stat-label">Vehicles Available</span>
            <span class="stat-value" id="statVehiclesAvail">22</span>
          </div>
          <div class="stat-item">
            <div class="stat-indicator amber"></div>
            <span class="stat-label">In Maintenance</span>
            <span class="stat-value" id="statVehiclesMaint">8</span>
          </div>
          <div class="stat-item">
            <div class="stat-indicator purple"></div>
            <span class="stat-label">Unassigned Jobs</span>
            <span class="stat-value" id="statUnassigned">7</span>
          </div>
        </div>

        <div class="main-content">
    <div class="heatmap-view">
      <div class="heatmap-left">
        <div class="heatmap-section" id="driversSection">
          <div class="section-header" onclick="toggleSection('driversSection')">
            <div class="section-header-left">
              <span class="section-toggle">‚ñº</span>
              <div class="section-title">DRIVERS <span class="section-count" id="driverCount">104</span></div>
            </div>
            <div class="section-controls">
              <div class="section-stats">
                <div class="section-stat"><div class="mini-dot green"></div> <span id="driverAvail">28</span> avail</div>
                <div class="section-stat"><div class="mini-dot red"></div> <span id="driverLeave">12</span> leave</div>
              </div>
              <button class="section-btn" onclick="event.stopPropagation(); expandSection('driversSection')">‚§¢</button>
              <button class="section-btn" onclick="event.stopPropagation(); popoutSection('drivers')">‚ßâ</button>
            </div>
          </div>
          <div class="filter-bar" id="driverFilterBar">
            <input type="text" class="filter-search" id="driverSearch" placeholder="Search drivers..." 
                   oninput="applyDriverFilters()" onclick="event.stopPropagation()">
            <select class="filter-select" id="driverStatusFilter" onchange="applyDriverFilters()" onclick="event.stopPropagation()">
              <option value="all">All Status</option>
              <option value="active">Active (Hide Leave)</option>
              <option value="available">Available Only</option>
              <option value="working">Working Only</option>
              <option value="leave">On Leave Only</option>
            </select>
            <select class="filter-select" id="driverSort" onchange="applyDriverFilters()" onclick="event.stopPropagation()">
              <option value="status">Sort: Status</option>
              <option value="name">Sort: Name</option>
            </select>
            <button class="filter-toggle-btn" id="showCancelledBtn" onclick="event.stopPropagation(); toggleShowCancelled()" title="Show cancelled duties on Gantt">
              Show Cancelled
            </button>
          </div>
          <div class="timeline-header">
            <div class="timeline-label-col">Name</div>
            <div class="timeline-hours" id="driverTimelineHeader"></div>
          </div>
          <div class="heatmap-rows" id="driverRows"></div>
          <div class="vertical-container" id="driverVertical"></div>
        </div>

        <div class="section-resize-handle" id="resizeDriverVehicle" data-above="driversSection" data-below="vehiclesSection"></div>

        <div class="heatmap-section" id="vehiclesSection">
          <div class="section-header" onclick="toggleSection('vehiclesSection')">
            <div class="section-header-left">
              <span class="section-toggle">‚ñº</span>
              <div class="section-title">VEHICLES <span class="section-count" id="vehicleCount">80</span></div>
            </div>
            <div class="section-controls">
              <div class="section-stats">
                <div class="section-stat"><div class="mini-dot green"></div> <span id="vehicleAvail">22</span> avail</div>
                <div class="section-stat"><div class="mini-dot amber"></div> <span id="vehicleMaint">8</span> maint</div>
              </div>
              <button class="section-btn" onclick="event.stopPropagation(); expandSection('vehiclesSection')">‚§¢</button>
              <button class="section-btn" onclick="event.stopPropagation(); popoutSection('vehicles')">‚ßâ</button>
            </div>
          </div>
          <div class="filter-bar" id="vehicleFilterBar">
            <input type="text" class="filter-search" id="vehicleSearch" placeholder="Search vehicles..." 
                   oninput="applyVehicleFilters()" onclick="event.stopPropagation()">
            <select class="filter-select" id="vehicleStatusFilter" onchange="applyVehicleFilters()" onclick="event.stopPropagation()">
              <option value="all">All Status</option>
              <option value="active">Active (Hide Maint)</option>
              <option value="available">Available Only</option>
              <option value="inuse">In Use Only</option>
              <option value="maintenance">Maintenance Only</option>
            </select>
            <select class="filter-select" id="vehicleSort" onchange="applyVehicleFilters()" onclick="event.stopPropagation()">
              <option value="status">Sort: Status</option>
              <option value="id">Sort: ID</option>
            </select>
          </div>
          <div class="timeline-header">
            <div class="timeline-label-col">Vehicle</div>
            <div class="timeline-hours" id="vehicleTimelineHeader"></div>
          </div>
          <div class="heatmap-rows" id="vehicleRows"></div>
          <div class="vertical-container" id="vehicleVertical"></div>
        </div>

        <div class="section-resize-handle" id="resizeVehicleUnassigned" data-above="vehiclesSection" data-below="unassignedSection"></div>

        <div class="heatmap-section unassigned" id="unassignedSection">
          <div class="section-header" onclick="toggleSection('unassignedSection')">
            <div class="section-header-left">
              <span class="section-toggle">‚ñº</span>
              <div class="section-title">UNASSIGNED <span class="section-count" id="unassignedCount">7</span></div>
            </div>
            <div class="section-controls">
              <button class="section-btn" onclick="event.stopPropagation(); expandSection('unassignedSection')">‚§¢</button>
              <button class="section-btn" onclick="event.stopPropagation(); popoutSection('unassigned')">‚ßâ</button>
            </div>
          </div>
          <div class="timeline-header">
            <div class="timeline-label-col">Job</div>
            <div class="timeline-hours" id="unassignedTimelineHeader"></div>
          </div>
          <div class="heatmap-rows" id="unassignedRows"></div>
          <div class="vertical-container" id="unassignedVertical"></div>
        </div>
      </div>

      <div class="panel-resize-handle" id="panelResizeHandle"></div>

      <div class="detail-panel" id="detailPanel">
        <div class="empty-panel">
          <div class="empty-text">Select a driver, vehicle, or job</div>
        </div>
      </div>
    </div>
    </div>
      </div><!-- end screen-dispatch -->
      
      <!-- HRM Screen -->
      <div class="screen" id="screen-hrm" style="display: none;">
        <div class="screen-header-bar">
          <h2>Human Resources</h2>
          <div id="hrmHeaderActions" style="display: flex; gap: 8px; align-items: center;">
            <button class="btn-settings" onclick="showEmployeeFieldsSettings()" title="Custom Fields Settings">‚öôÔ∏è</button>
            <button class="btn-primary" onclick="showAddEmployeeModal()">+ Add Employee</button>
          </div>
        </div>
        
        <!-- HRM Sub-navigation -->
        <div class="hrm-tabs">
          <button class="hrm-tab active" onclick="switchHrmTab('employees')">Employees</button>
          <button class="hrm-tab" onclick="switchHrmTab('pay-types')">Pay Types</button>
        </div>
        
        <!-- Employees Tab -->
        <div class="hrm-tab-content active" id="hrmTabEmployees">
          <div class="screen-filters">
            <input type="text" class="filter-input" placeholder="Search employees..." oninput="filterEmployees(this.value)">
            <select class="filter-select" onchange="filterEmployeeRole(this.value)">
              <option value="">All Roles</option>
              <option value="driver">Drivers</option>
              <option value="dispatcher">Dispatchers</option>
              <option value="admin">Admins</option>
            </select>
          </div>
          <div class="screen-table-container">
            <table class="screen-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Licence</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="employeesTableBody">
                <tr><td colspan="7" class="loading-cell">Loading employees...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Pay Types Tab -->
        <div class="hrm-tab-content" id="hrmTabPayTypes">
          <div class="screen-filters" style="justify-content: flex-end;">
            <button class="btn-primary" onclick="showAddPayTypeModal()">+ Add Pay Type</button>
          </div>
          <div class="screen-table-container">
            <table class="screen-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Hourly Rate</th>
                  <th>Multiplier</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="payTypesTableBody">
                <tr><td colspan="6" class="loading-cell">Loading pay types...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Operations Calendar Screen -->
      <div class="screen" id="screen-calendar" style="display: none;">
        <div class="screen-header-bar">
          <h2>Operations Calendar</h2>
          <div style="display: flex; gap: 12px; align-items: center;">
            <button class="btn-secondary" onclick="changeCalendarMonth(-1)">‚Üê Prev</button>
            <span id="calendarMonthLabel" style="font-size: 16px; font-weight: 600; min-width: 140px; text-align: center;"></span>
            <button class="btn-secondary" onclick="changeCalendarMonth(1)">Next ‚Üí</button>
            <button class="btn-secondary" onclick="goToCalendarToday()" style="margin-left: 8px;">Today</button>
          </div>
        </div>
        
        <div class="ops-calendar-container">
          <div class="ops-calendar-grid" id="opsCalendarGrid">
            <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading calendar...</div>
          </div>
          
          <div class="ops-calendar-sidebar">
            <div class="ops-sidebar-header">
              <h3>Rosters This Month</h3>
            </div>
            <div class="ops-roster-list" id="opsRosterList"></div>
          </div>
        </div>
      </div>
      
      <!-- Vehicles Screen -->
      <div class="screen" id="screen-vehicles" style="display: none;">
        <div class="screen-header-bar">
          <h2>Vehicle Fleet</h2>
          <button class="btn-primary" onclick="showAddVehicleModal()">+ Add Vehicle</button>
        </div>
        <div class="screen-filters">
          <input type="text" class="filter-input" placeholder="Search vehicles..." oninput="filterVehicles(this.value)">
          <select class="filter-select" onchange="filterVehicleStatus(this.value)">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div class="screen-table-container">
          <table class="screen-table">
            <thead>
              <tr>
                <th>Fleet #</th>
                <th>Rego</th>
                <th>Capacity</th>
                <th>Make/Model</th>
                <th>Year</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="vehiclesTableBody">
              <tr><td colspan="7" class="loading-cell">Loading vehicles...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Shift Templates Screen -->
      <div class="screen" id="screen-shifts" style="display: none;">
        <div class="screen-header-bar">
          <h2>Shift Templates</h2>
          <button class="btn-primary" onclick="showAddShiftModal()">+ Add Template</button>
        </div>
        <div class="screen-filters">
          <input type="text" class="filter-input" placeholder="Search templates..." oninput="filterShifts(this.value)">
          <select class="filter-select" onchange="filterShiftType(this.value)">
            <option value="">All Types</option>
            <option value="regular">Regular</option>
            <option value="charter">Charter</option>
            <option value="school">School</option>
          </select>
        </div>
        <div class="screen-table-container">
          <table class="screen-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Type</th>
                <th>Start</th>
                <th>End</th>
                <th>Duration</th>
                <th>Duties</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="shiftsTableBody">
              <tr><td colspan="8" class="loading-cell">Loading shift templates...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Roster Screen -->
      <div class="screen" id="screen-roster" style="display: none;">
        <!-- Roster List View -->
        <div id="rosterListView">
          <div class="screen-header-bar">
            <h2>Rosters</h2>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="rosterSearchInput" placeholder="Search rosters..." class="search-input" style="width: 200px;" onkeyup="filterRosters()">
              <button class="btn-primary" onclick="showAddRosterModal()">+ New Roster</button>
            </div>
          </div>
          <div class="screen-table-container">
            <table class="screen-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Date Range</th>
                  <th>Status</th>
                  <th>Entries</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="rosterListTableBody">
                <tr><td colspan="6" class="loading-cell">Loading rosters...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Roster Detail/Gantt View -->
        <div id="rosterDetailView" style="display: none; flex-direction: column; height: 100%;">
          <div class="screen-header-bar">
            <div style="display: flex; align-items: center; gap: 16px;">
              <button class="btn-secondary" onclick="backToRosterList()">‚Üê Back</button>
              <h2 id="rosterDetailTitle">Roster Detail</h2>
              <span id="rosterDetailDates" style="color: var(--text-muted); font-size: 13px;"></span>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="btn-secondary" onclick="changeRosterDay(-1)">‚Üê Prev</button>
              <input type="date" id="rosterDayPicker" onchange="goToRosterDay(this.value)" style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px 10px; border-radius: 4px;">
              <button class="btn-secondary" onclick="changeRosterDay(1)">Next ‚Üí</button>
            </div>
          </div>
          
          <!-- Day Info Bar -->
          <div id="rosterDayInfoBar" style="padding: 12px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span id="rosterDayLabel" style="font-size: 16px; font-weight: 600; color: var(--text-primary);"></span>
              <span id="rosterDayHoliday" style="margin-left: 12px; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: var(--accent-orange); color: white; display: none;"></span>
            </div>
            <div id="rosterDayStats" style="font-size: 12px; color: var(--text-muted);"></div>
          </div>
          
          <!-- Gantt Container -->
          <div id="rosterGanttContainer" style="flex: 1; overflow: auto; padding: 16px;">
            <div id="rosterGantt" class="roster-gantt">
              <!-- Gantt content rendered here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Charters Screen -->
      <div class="screen" id="screen-charters" style="display: none;">
        <div class="screen-placeholder">
          <div class="screen-placeholder-title">Charter Management</div>
          <div class="screen-placeholder-desc">Create, manage, and track charter bookings and quotations.</div>
        </div>
      </div>
      
      <!-- Customers Screen -->
      <div class="screen" id="screen-customers" style="display: none;">
        <div class="screen-placeholder">
          <div class="screen-placeholder-title">Customers</div>
          <div class="screen-placeholder-desc">Manage customer accounts, contacts, and booking history.</div>
        </div>
      </div>
      
      <!-- Maintenance Screen -->
      <div class="screen" id="screen-maintenance" style="display: none;">
        <div class="screen-placeholder">
          <div class="screen-placeholder-title">Maintenance</div>
          <div class="screen-placeholder-desc">Schedule and track vehicle maintenance, repairs, and servicing.</div>
        </div>
      </div>
      
    </div><!-- end app-body -->
  </div><!-- end app-container -->

  <div class="toast" id="toast">
    <span class="toast-message" id="toastMessage">Done</span>
  </div>

  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script src="js/dispatch.js"></script>
  <script src="js/hrm.js"></script>
  <script src="js/vehicles.js"></script>
  <script src="js/shifts.js"></script>
  <script src="js/roster.js"></script>
  
  
  <!-- Employee Modal -->
  <div class="crud-modal-overlay" id="employeeModalOverlay">
    <div class="crud-modal crud-modal-tabbed">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="employeeModalTitle">Add Employee</span>
        <button class="crud-modal-close" onclick="closeEmployeeModal()">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchEmployeeTab('general')">General</button>
        <button class="modal-tab" onclick="switchEmployeeTab('custom')">Custom Fields</button>
      </div>
      <div class="crud-modal-body" style="padding: 0;">
        <form id="employeeForm" onsubmit="event.preventDefault(); saveEmployee();">
          <!-- General Tab -->
          <div class="modal-tab-content active" id="empTabGeneral">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Employee Number *</label>
                <input type="text" id="empNumber" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Role</label>
                <select id="empRole" class="form-input">
                  <option value="driver">Driver</option>
                  <option value="dispatcher">Dispatcher</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">First Name *</label>
                <input type="text" id="empFirstName" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name *</label>
                <input type="text" id="empLastName" class="form-input" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="empEmail" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" id="empPhone" class="form-input">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Licence Number</label>
                <input type="text" id="empLicence" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Status</label>
                <select id="empStatus" class="form-input">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Custom Fields Tab -->
          <div class="modal-tab-content" id="empTabCustom">
            <div id="empCustomFieldsContainer">
              <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading custom fields...</div>
            </div>
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeEmployeeModal()">Cancel</button>
        <button class="btn-primary" onclick="saveEmployee()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Employee Custom Fields Settings Modal -->
  <div class="crud-modal-overlay" id="employeeFieldsSettingsOverlay">
    <div class="crud-modal crud-modal-wide">
      <div class="crud-modal-header">
        <span class="crud-modal-title">Custom Fields Settings</span>
        <button class="crud-modal-close" onclick="closeEmployeeFieldsSettings()">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchFieldsSettingsTab('fields')">Fields</button>
        <button class="modal-tab" onclick="switchFieldsSettingsTab('layout')">Layout Designer</button>
      </div>
      <div class="crud-modal-body" style="padding: 0;">
        <!-- Fields Tab -->
        <div class="modal-tab-content active" id="fieldsTabFields">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
              Define custom fields that will appear on all employee records.
            </p>
            <button class="btn-primary" onclick="showAddCustomFieldModal()">+ Add Field</button>
          </div>
          <div class="custom-fields-list" id="customFieldsList">
            <div class="custom-fields-empty">No custom fields defined yet.</div>
          </div>
        </div>
        
        <!-- Layout Tab -->
        <div class="modal-tab-content" id="fieldsTabLayout">
          <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 16px 0;">
            Drag fields to arrange them on the form. Use the width buttons to set half or full width.
          </p>
          <div class="layout-editor">
            <div class="layout-preview" id="layoutPreview">
              <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading layout...</div>
            </div>
            <div class="layout-add-row">
              <button onclick="addLayoutRow()">+ Add Row</button>
            </div>
          </div>
          <div style="margin-top: 16px; text-align: right;">
            <button class="btn-primary" onclick="saveFieldLayouts()">Save Layout</button>
          </div>
        </div>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeEmployeeFieldsSettings()">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Custom Field Modal -->
  <div class="crud-modal-overlay" id="customFieldModalOverlay">
    <div class="crud-modal">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="customFieldModalTitle">Add Custom Field</span>
        <button class="crud-modal-close" onclick="closeCustomFieldModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <form id="customFieldForm" onsubmit="event.preventDefault(); saveCustomField();">
          <input type="hidden" id="customFieldId">
          <div class="form-group">
            <label class="form-label">Field Name *</label>
            <input type="text" id="customFieldName" class="form-input" placeholder="e.g., Training Date" required>
          </div>
          <div class="form-group">
            <label class="form-label">Field Key *</label>
            <input type="text" id="customFieldKey" class="form-input" placeholder="e.g., training_date" required>
            <small style="color: var(--text-muted); font-size: 11px;">Lowercase, no spaces. Used for data storage.</small>
          </div>
          <div class="form-group">
            <label class="form-label">Field Type *</label>
            <select id="customFieldType" class="form-input" onchange="toggleFieldOptions()">
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="date">Date</option>
              <option value="boolean">Yes/No (Checkbox)</option>
              <option value="select">Dropdown (Select)</option>
            </select>
          </div>
          <div class="form-group" id="customFieldOptionsGroup" style="display: none;">
            <label class="form-label">Options (one per line) *</label>
            <textarea id="customFieldOptions" class="form-input" rows="4" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Field Width</label>
              <select id="customFieldWidth" class="form-input">
                <option value="full">Full Width</option>
                <option value="half">Half Width</option>
              </select>
            </div>
            <div class="form-group" style="display: flex; align-items: center; padding-top: 22px;">
              <label class="form-label" style="margin-bottom: 0;">
                <input type="checkbox" id="customFieldRequired"> Required field
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeCustomFieldModal()">Cancel</button>
        <button class="btn-primary" onclick="saveCustomField()">Save Field</button>
      </div>
    </div>
  </div>
  
  <!-- Pay Type Modal -->
  <div class="crud-modal-overlay" id="payTypeModalOverlay">
    <div class="crud-modal">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="payTypeModalTitle">Add Pay Type</span>
        <button class="crud-modal-close" onclick="closePayTypeModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <form id="payTypeForm" onsubmit="event.preventDefault(); savePayType();">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Code *</label>
              <input type="text" id="payTypeCode" class="form-input" placeholder="e.g., OT" required maxlength="10" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" id="payTypeName" class="form-input" placeholder="e.g., Overtime" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Hourly Rate ($) *</label>
              <input type="number" id="payTypeRate" class="form-input" placeholder="0.00" required step="0.01" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">Multiplier</label>
              <input type="number" id="payTypeMultiplier" class="form-input" placeholder="1.0" step="0.05" min="0" value="1.0">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Display Order</label>
              <input type="number" id="payTypeOrder" class="form-input" placeholder="0" min="0" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="payTypeStatus" class="form-input">
                <option value="1">Active</option>
                <option value="0">Inactive</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closePayTypeModal()">Cancel</button>
        <button class="btn-primary" onclick="savePayType()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Vehicle Modal -->
  <div class="crud-modal-overlay" id="vehicleModalOverlay">
    <div class="crud-modal">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="vehicleModalTitle">Add Vehicle</span>
        <button class="crud-modal-close" onclick="closeVehicleModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <form id="vehicleForm" onsubmit="event.preventDefault(); saveVehicle();">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fleet Number *</label>
              <input type="text" id="vehFleet" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Registration *</label>
              <input type="text" id="vehRego" class="form-input" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Capacity *</label>
              <input type="number" id="vehCapacity" class="form-input" min="1" required>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="vehStatus" class="form-input">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Make</label>
              <input type="text" id="vehMake" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Model</label>
              <input type="text" id="vehModel" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Year</label>
            <input type="number" id="vehYear" class="form-input" min="1900" max="2099">
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeVehicleModal()">Cancel</button>
        <button class="btn-primary" onclick="saveVehicle()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Cancel Duty Confirmation Modal -->
  <div class="crud-modal-overlay" id="cancelDutyModalOverlay">
    <div class="crud-modal" style="width: 400px;">
      <div class="crud-modal-header">
        <span class="crud-modal-title">Cancel Duty Line</span>
        <button class="crud-modal-close" onclick="closeCancelDutyModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">
          This will cancel the duty line for dispatch purposes only. The roster will not be affected.
        </p>
        <div id="cancelDutyInfo" style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
          <!-- Duty info will be populated here -->
        </div>
        <div class="form-group">
          <label class="form-label">Reason (optional)</label>
          <input type="text" id="cancelDutyReason" class="form-input" placeholder="e.g. Customer cancelled, Weather...">
        </div>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeCancelDutyModal()">Keep Active</button>
        <button class="btn-primary" style="background: var(--accent-amber);" onclick="confirmCancelDuty()">Cancel Duty</button>
      </div>
    </div>
  </div>
  
  <!-- Shift Template Modal -->
  <div class="crud-modal-overlay" id="shiftModalOverlay">
    <div class="crud-modal crud-modal-wide">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="shiftModalTitle">Add Shift Template</span>
        <button class="crud-modal-close" onclick="closeShiftModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <form id="shiftForm" onsubmit="event.preventDefault(); saveShift();">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Code *</label>
              <input type="text" id="shiftCode" class="form-input" placeholder="e.g. AM-01" required>
            </div>
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" id="shiftName" class="form-input" placeholder="e.g. Morning Route 1" required>
            </div>
            <div class="form-group">
              <label class="form-label">Type</label>
              <select id="shiftType" class="form-input">
                <option value="regular">Regular</option>
                <option value="charter">Charter</option>
                <option value="school">School</option>
              </select>
            </div>
          </div>
          
          <div class="form-section">
            <div class="form-section-header">
              <span class="form-section-title">Duties</span>
              <button type="button" class="btn-small" onclick="addShiftDutyBlock()">+ Add Duty</button>
            </div>
            <div class="duty-blocks-container" id="shiftDutyBlocks">
              <div class="duty-editor-empty">No duties added. Click "+ Add Duty" to start.</div>
            </div>
            <div class="duty-editor-totals" id="shiftDutyTotals"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea id="shiftNotes" class="form-input" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeShiftModal()">Cancel</button>
        <button class="btn-primary" onclick="saveShift()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Roster Modal -->
  <div class="crud-modal-overlay" id="rosterModalOverlay">
    <div class="crud-modal">
      <div class="crud-modal-header">
        <span class="crud-modal-title" id="rosterModalTitle">New Roster</span>
        <button class="crud-modal-close" onclick="closeRosterModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <form id="rosterForm" onsubmit="event.preventDefault(); saveRoster();">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Code *</label>
              <input type="text" id="rosterCode" class="form-input" required placeholder="e.g. WK01-JAN25">
            </div>
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" id="rosterName" class="form-input" required placeholder="e.g. Week 1 January 2025">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Start Date *</label>
              <input type="date" id="rosterStartDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">End Date *</label>
              <input type="date" id="rosterEndDate" class="form-input" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="rosterStatus" class="form-input">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
                <option value="archived">Archived</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea id="rosterNotes" class="form-input" rows="2" placeholder="Optional notes..."></textarea>
          </div>
        </form>
      </div>
      <div class="crud-modal-footer">
        <button class="btn-secondary" onclick="closeRosterModal()">Cancel</button>
        <button class="btn-primary" onclick="saveRoster()">Save Roster</button>
      </div>
    </div>
  </div>
  
  <!-- Schedule Roster Modal -->
  <div class="schedule-modal-overlay" id="scheduleModalOverlay">
    <div class="schedule-modal">
      <div class="schedule-modal-header">
        <span class="schedule-modal-title">Add Roster to Calendar</span>
        <button class="schedule-modal-close" onclick="closeScheduleModal()">&times;</button>
      </div>
      <div class="schedule-modal-body">
        <div style="margin-bottom: 16px;">
          <strong id="scheduleRosterName"></strong>
          <div id="scheduleValidRange" style="font-size: 12px; color: var(--text-muted); margin-top: 4px;"></div>
        </div>
        <div class="form-group" style="margin-bottom: 12px;">
          <label class="form-label">Calendar Start Date</label>
          <input type="date" id="scheduleStartDate" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Calendar End Date</label>
          <input type="date" id="scheduleEndDate" class="form-input">
        </div>
        <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
          The roster will appear on the calendar for these dates. You can schedule a subset of the roster's valid date range.
        </p>
      </div>
      <div class="schedule-modal-footer">
        <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmScheduleRoster()">Add to Calendar</button>
      </div>
    </div>
  </div>
  
  <!-- Connected Blocks Modal -->
  <div class="crud-modal-overlay" id="connectedModalOverlay">
    <div class="crud-modal" style="max-width: 400px;">
      <div class="crud-modal-header">
        <span class="crud-modal-title">Multiple Blocks in Shift</span>
        <button class="crud-modal-close" onclick="closeConnectedModal()">&times;</button>
      </div>
      <div class="crud-modal-body">
        <p style="margin: 0 0 16px 0; color: var(--text-secondary);">
          This shift has multiple duty blocks. Would you like to assign all connected blocks to this driver?
        </p>
      </div>
      <div class="crud-modal-footer" style="justify-content: space-between;">
        <button class="btn-secondary" onclick="confirmConnected(false)">Just This Block</button>
        <button class="btn-primary" onclick="confirmConnected(true)">All Connected Blocks</button>
      </div>
    </div>
  </div>
</body>
</html>
